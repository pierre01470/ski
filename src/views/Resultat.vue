<template>
  <section class="main-resultat">
    <div class="file-upload">
      <form
        v-on:submit.prevent="submitForm"
        action=""
        method="post"
        enctype="multipart/form-data"
      >
        <input
          @change="previewExcel"
          type="file"
          id="excel"
          name="photo"
          value="Photo"
          placeholder="Photo"
          size="80px"
        />
        <label for="file"></label>
        <input type="submit" value="Ajout participant" />
      </form>
    </div>
    <div class="back-date" v-for="trial in trials" :key="trial.id_trial">
      <div class="station">
        <h2>Nom de la station</h2>
        <div class="name-station">
          <p>{{ trial.name_station }}</p>
        </div>
      </div>
      <div class="test">
        <h2>Date de l'épreuve</h2>
        <div class="date-epr">
          <p>{{ trial.date }}</p>
        </div>
      </div>
    </div>

    <div class="category">
      <table>
        <thead class="header-table">
          <tr>
            <th scope="col">Photo</th>
            <th scope="col">Nom</th>
            <th scope="col">Prénom</th>
            <th id="cat" scope="col" v-on:click="orderByCategory()">
              Catégorie
            </th>
            <th scope="col">Dossard</th>
            <th scope="col">Temps</th>
            <th scope="col">Classement</th>
            <th scope="col">SUPPRIMER</th>
          </tr>
        </thead>
        <tbody class="body-table" id="infinite-list">
          <tr v-for="value in participants" :key="value.id_participant">
            <td>
              <img
                :src="require(`@/assets/ressources/${value.photo}`)"
                alt="photo"
                id="infinite-list"
              />
            </td>
            <td>{{ value.lastname }}</td>
            <td>{{ value.firstname }}</td>
            <td>{{ value.name_category }}</td>
            <td>{{ value.number }}</td>
            <td>temps</td>
            <td>{{ value.id_trial }}</td>
            <td>
              <button v-on:click="del(value.id_participant)">
                <img
                  class="poubelle"
                  src="@/assets/ressources/poubelle.png"
                  height="45px"
                  width="45px"
                  id="test"
                  alt=""
                />
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</template>

<script>
const axios = require("axios");
export default {
  data() {
    return {
      participants: [],
      categories: [],
      trials: [],
      runs: [],
      url: "",
      trial: {
        station_name: "",
        registration_date: "",
      },
      form: {
        lastname: "",
        firstname: "",
        email: "",
        date_birth: "",
        number: "",
        category: "",
      },
    };
  },
  async mounted() {
    const responseParticipants = await axios.get(
      `http://localhost/ski/API/participant`
    );
    this.participants = responseParticipants.data;

    const responseCategory = await axios.get(
      `http://localhost/ski/API/categoryByName`
    );
    this.categories = responseCategory.data;

    const responseTrial = await axios.get(`http://localhost/ski/API/trial`);
    this.trials = responseTrial.data;

    const responseRun = await axios.get(`http://localhost/ski/API/run`);
    this.runs = responseRun.data;
  },

  methods: {
    async del(id) {
      var r = confirm("Etes-vous sûr de vouloir supprimer ce participant?");
      if (r == true) {
        await axios.get(`http://localhost/ski/API/deleteParticipant` + id);
        const responseParticipants = await axios.get(
          `http://localhost/ski/API/participant`
        );
        this.participants = responseParticipants.data;
      }
    },
    async orderByCategory() {
      const responseParticipants = await axios.get(
        `http://localhost/ski/API/participantByCategory`
      );
      this.participants = responseParticipants.data;
    },
    previewExcel(e) {
      const selectedImage = e.target.files[0];
      this.createBase64Image(selectedImage);
      this.url = URL.createObjectURL(selectedImage);
    },
    createBase64Image(fileObject) {
      const reader = new FileReader();
      reader.onload = (e) => {
        this.form.photo = e.target.result;
      };
      reader.readAsDataURL(fileObject);
    },
    async submitForm() {
      // Send form participants
      console.log(this.form);
      await axios.post(`http://localhost/ski/API/importExcel`, this.form);
    },

    async submitExcel() {
      // Send form participants
      await axios.post(`http://localhost/ski/API/importExcel`, this.form);
      this.participants = responseParticipants.data;
    },
  },
};
</script>
